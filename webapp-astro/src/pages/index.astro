---
import Welcome from "../components/Welcome.astro";
import Layout from "../layouts/Layout.astro";
import { createSupabaseAnon } from "../lib/supabase";
import type { AppCookie } from "../lib/types";

export const prerender = false;

function logoutCookies() {
  Astro.cookies.delete("app", {
    path: "/",
  });
}

function redirectToLoginPage() {
  return Astro.redirect("/login");
}

const appCookie = Astro.cookies.get("app")?.json() as AppCookie | undefined;
if (!appCookie?.access_token || !appCookie?.refresh_token) {
  return redirectToLoginPage();
}

const supabase = createSupabaseAnon();
let session;
try {
  session = await supabase.auth.setSession({
    refresh_token: appCookie.refresh_token,
    access_token: appCookie.access_token,
  });
  if (session.error) {
    logoutCookies();
    return redirectToLoginPage();
  }
} catch (error) {
  logoutCookies();
  return redirectToLoginPage();
}
---

<Layout>
  <Welcome />
</Layout>
